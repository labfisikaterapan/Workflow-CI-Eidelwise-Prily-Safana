name: Kriteria 3 ADVANCED - ML Pipeline with Docker
# Nama: Eidelwise Prily Safana
# Level: ADVANCED (4 pts)

on:
  push:
    branches:
      - main
    paths:
      - 'MLProject/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Manual trigger

jobs:
  ml-training-and-docker:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v3
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow scikit-learn pandas numpy joblib matplotlib seaborn
        
    - name: ğŸš€ Run MLflow Project (Training)
      id: train
      working-directory: ./MLProject
      run: |
        echo "=== Running MLflow Project ==="
        mlflow run . \
          --experiment-name "DiabetesClassifier_Eidelwise_CI" \
          -P n_estimators=100 \
          -P max_depth=10 \
          -P min_samples_split=2 \
          -P min_samples_leaf=1 \
          -P random_state=42
        echo "âœ… Training completed!"
        
        # Get the run_id from mlruns
        RUN_ID=$(ls -td mlruns/0/*/ 2>/dev/null | grep -v 'meta.yaml' | head -1 | xargs -I {} basename {})
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Run ID: $RUN_ID"
        
        # Show directory structure
        echo "=== MLruns structure ==="
        find mlruns -type d -name "artifacts" 2>/dev/null || echo "No artifacts found yet"
        find mlruns -type d -name "model" 2>/dev/null || echo "No model found yet"
        
    - name: ğŸ“Š Display MLflow Tracking
      run: |
        echo "âœ… Model training completed!"
        echo "ğŸ“ˆ MLflow run completed successfully"
        echo "ğŸ” Run ID: ${{ steps.train.outputs.run_id }}"
        
    - name: ğŸ’¾ Save Model Artifacts to GitHub
      uses: actions/upload-artifact@v3
      with:
        name: diabetes-model-artifacts
        path: |
          MLProject/mlruns/
          MLProject/*.joblib
          MLProject/*.png
          MLProject/*.json
        retention-days: 30
        if-no-files-found: warn
        
    - name: ğŸ³ Setup Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: ğŸ”‘ Login to Docker Hub
      if: github.event_name == 'push'
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
      continue-on-error: true
        
    - name: ğŸ—ï¸ Build Docker Image with MLflow
      if: github.event_name == 'push'
      run: |
        cd MLProject
        echo "=== Building Docker Image ==="
        
        # Create Dockerfile for model serving
        cat > Dockerfile << 'EOF'
        FROM python:3.11-slim
        
        WORKDIR /app
        
        # Install dependencies
        RUN pip install --no-cache-dir mlflow scikit-learn pandas numpy joblib
        
        # Copy model and artifacts
        COPY mlruns/ /app/mlruns/
        COPY *.joblib /app/ 2>/dev/null || true
        
        # Expose port
        EXPOSE 5002
        
        # Set environment
        ENV MLFLOW_TRACKING_URI=file:///app/mlruns
        
        # Start MLflow server
        CMD ["mlflow", "models", "serve", "-m", "mlruns/0", "--port", "5002", "--host", "0.0.0.0", "--no-conda"]
        EOF
        
        docker build -t eidelwiseprily/diabetes-classifier:latest .
        echo "âœ… Docker image built successfully"
      continue-on-error: true
        
    - name: ğŸ“¤ Push Docker Image to Docker Hub
      if: github.event_name == 'push'
      run: |
        docker push eidelwiseprily/diabetes-classifier:latest
        echo "âœ… Docker image pushed: eidelwiseprily/diabetes-classifier:latest"
        echo "ğŸ”— Pull with: docker pull eidelwiseprily/diabetes-classifier:latest"
      continue-on-error: true
        
    - name: âœ… Workflow Summary
      run: |
        echo "ğŸ‰ Workflow completed successfully!"
        echo "=" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š MLflow CI/CD Summary" >> $GITHUB_STEP_SUMMARY
        echo "=" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‘¤ **Author:** Eidelwise Prily Safana" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ¯ **Kriteria:** 3 - ADVANCED (4 pts)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Completed Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ MLflow Project executed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Model trained and tracked" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Artifacts saved to GitHub" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Docker image built (if push event)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Docker image pushed to Hub (if push event)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ³ **Docker Image:** eidelwiseprily/diabetes-classifier:latest" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ‰ Automated training workflow completed successfully!"
        echo "ğŸ‘¤ Author: Eidelwise Prily Safana"
        echo "ğŸ³ Docker Image: eidelwiseprily/diabetes-classifier:latest"
